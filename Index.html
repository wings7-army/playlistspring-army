<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Creador de Playlist ARMY</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #1db95410;
    }
    h1 { color: #1db954; }
    input, button, select {
      padding: 8px;
      margin: 5px 0;
      font-size: 16px;
    }
    .song-result {
      margin-top: 10px;
      padding: 10px;
      background-color: #f3f3f3;
      border-radius: 6px;
    }
  </style>
</head>
<body>

  <h1>ðŸŽµ Creador de Playlist ARMY</h1>

  <button id="login-btn">Autorizar con Spotify</button>
  <p id="user-info"></p>

  <hr>

  <label for="search">Buscar canciÃ³n:</label>
  <input type="text" id="search" placeholder="Ej. Fake Love">
  <button id="search-btn">Buscar</button>

  <div id="results"></div>

  <hr>

  <label for="playlist-name">Nombre de la nueva playlist:</label>
  <input type="text" id="playlist-name" placeholder="Ej. Playlist de prueba">

  <button id="create-playlist">Crear playlist con canciones seleccionadas</button>

  <script>
    const CLIENT_ID = "ddaaec1fa4354bb88b12908a5db63f52";
    const REDIRECT_URI = "https://wings7-army.github.io/playlistspring-army/";
    const AUTH_ENDPOINT = "https://accounts.spotify.com/authorize";
    const RESPONSE_TYPE = "token";

    let accessToken = null;
    let userId = null;
    let selectedTracks = [];

    document.getElementById("login-btn").addEventListener("click", () => {
      window.location = `${AUTH_ENDPOINT}?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=${RESPONSE_TYPE}&scope=playlist-modify-public`;
    });

    window.onload = async () => {
      const hash = window.location.hash;
      if (hash && hash.includes("access_token")) {
        accessToken = hash.split("&")[0].split("=")[1];
        window.history.pushState("", document.title, REDIRECT_URI); // limpia la URL

        const userResp = await fetch("https://api.spotify.com/v1/me", {
          headers: { Authorization: "Bearer " + accessToken }
        });
        const userData = await userResp.json();
        userId = userData.id;
        document.getElementById("user-info").innerText = `Conectado como: ${userData.display_name}`;
      }
    };

    document.getElementById("search-btn").addEventListener("click", async () => {
      const query = document.getElementById("search").value;
      if (!accessToken || !query) return;

      const resp = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=5`, {
        headers: { Authorization: "Bearer " + accessToken }
      });
      const data = await resp.json();

      const results = document.getElementById("results");
      results.innerHTML = "";

      data.tracks.items.forEach(track => {
        const div = document.createElement("div");
        div.className = "song-result";
        div.innerHTML = `
          <strong>${track.name}</strong> - ${track.artists[0].name}<br>
          <input type="number" min="1" max="120" value="1" id="count-${track.id}">
          <button onclick="addTrack('${track.uri}', '${track.id}')">Agregar</button>
        `;
        results.appendChild(div);
      });
    });

    window.addTrack = (uri, id) => {
      const count = parseInt(document.getElementById(`count-${id}`).value);
      if (count > 120) {
        alert("MÃ¡ximo permitido: 120 veces por canciÃ³n");
        return;
      }
      for (let i = 0; i < count; i++) {
        selectedTracks.push(uri);
      }
      alert(`Agregada ${count} vez/veces`);
    };

    document.getElementById("create-playlist").addEventListener("click", async () => {
      const name = document.getElementById("playlist-name").value || "Nueva Playlist";
      if (!accessToken || !userId || selectedTracks.length === 0) {
        alert("Debe estar logueado, buscar canciones y asignar un nombre.");
        return;
      }

      const createResp = await fetch(`https://api.spotify.com/v1/users/${userId}/playlists`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ name })
      });

      const playlist = await createResp.json();

      for (let i = 0; i < selectedTracks.length; i += 100) {
        const chunk = selectedTracks.slice(i, i + 100);
        await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
          method: "POST",
          headers: {
            Authorization: "Bearer " + accessToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ uris: chunk })
        });
      }

      alert(`âœ… Playlist "${name}" creada correctamente`);
      selectedTracks = [];
    });
  </script>

</body>
</html>
